<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PepsiCoPilot Sales Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <style>
    :root {
      color-scheme: dark;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #050714;
      color: #f5f6fb;
      min-height: 100vh;
      overflow-x: hidden;
    }
    .bg-blobs::before,
    .bg-blobs::after {
      content: "";
      position: absolute;
      width: 480px;
      height: 480px;
      filter: blur(180px);
      opacity: 0.6;
      z-index: 0;
    }
    .bg-blobs::before {
      top: -120px;
      left: -120px;
      background: radial-gradient(circle at center, rgba(167, 139, 250, 0.65), transparent 70%);
      animation: float 12s ease-in-out infinite;
    }
    .bg-blobs::after {
      bottom: -160px;
      right: -80px;
      background: radial-gradient(circle at center, rgba(14, 165, 233, 0.6), transparent 70%);
      animation: float 14s ease-in-out infinite reverse;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(40px); }
    }
    .page {
      position: relative;
      z-index: 1;
      width: min(1240px, calc(100% - 48px));
      margin: 0 auto;
      padding: 40px 24px 80px;
    }
    .hero {
      border-radius: 32px;
      padding: clamp(32px, 4vw, 72px);
      margin-bottom: 40px;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(120deg, rgba(109,40,217,0.35), rgba(59,130,246,0.38));
      box-shadow: 0 30px 80px rgba(15,23,42,0.5);
      backdrop-filter: blur(18px);
    }
    .hero::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(255,255,255,0.2), transparent 55%);
      mix-blend-mode: screen;
      pointer-events: none;
      animation: shimmer 10s linear infinite;
    }
    @keyframes shimmer {
      0% { transform: translateX(-50%) translateY(-30%); }
      100% { transform: translateX(50%) translateY(30%); }
    }
    .hero-content {
      position: relative;
      z-index: 1;
      text-align: center;
    }
    .hero-icon {
      font-size: clamp(32px, 6vw, 56px);
      margin-bottom: 12px;
      color: rgba(255,255,255,0.9);
    }
    .hero h1 {
      font-size: clamp(32px, 6vw, 56px);
      margin: 0;
      font-weight: 600;
      letter-spacing: -0.02em;
    }
    .hero p {
      margin: 12px auto 0;
      max-width: 620px;
      font-size: 18px;
      color: rgba(235,238,255,0.85);
    }
    .grid-two {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }
    .card {
      border-radius: 28px;
      background: rgba(15,23,42,0.55);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 20px 50px rgba(2,6,23,0.45);
      backdrop-filter: blur(18px);
      padding: 24px;
    }
    .card h2 {
      margin: 0;
      font-size: 22px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    label {
      display: block;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 12px;
      color: rgba(226,232,240,0.9);
    }
    textarea,
    input[type="date"],
    select {
      width: 100%;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 20px;
      padding: 14px 16px;
      background: rgba(15,23,42,0.65);
      color: #f3f4f6;
      font-size: 16px;
      font-family: inherit;
      outline: none;
      transition: border 0.2s ease, box-shadow 0.2s;
    }
    textarea:focus,
    input[type="date"]:focus,
    select:focus {
      border-color: rgba(139,92,246,0.9);
      box-shadow: 0 0 0 1px rgba(139,92,246,0.2);
    }
    textarea {
      height: 140px;
      resize: none;
    }
    .btn-primary,
    .btn-secondary {
      border: none;
      border-radius: 18px;
      font-size: 16px;
      font-weight: 600;
      padding: 14px 20px;
      cursor: pointer;
      transition: transform 0.25s ease, box-shadow 0.25s;
    }
    .btn-primary {
      background: linear-gradient(120deg, #d946ef, #8b5cf6, #3b82f6);
      color: white;
      box-shadow: 0 25px 40px rgba(88,28,135,0.3);
    }
    .btn-primary:hover { transform: translateY(-2px); }
    .btn-secondary {
      background: rgba(255,255,255,0.05);
      color: #e2e8f0;
      border: 1px solid rgba(255,255,255,0.12);
    }
    .quick-section h3 {
      margin: 0;
      font-size: 26px;
      font-weight: 600;
    }
    .quick-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 24px;
      margin-top: 24px;
    }
    .insight-card {
      border-radius: 24px;
      background: rgba(6,11,25,0.75);
      border: 1px solid rgba(255,255,255,0.08);
      padding: 20px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
      min-height: 260px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      transition: transform 0.25s ease, box-shadow 0.25s;
      position: relative;
      overflow: hidden;
    }
    .insight-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 35px 60px rgba(2,6,23,0.55);
    }
    .insight-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .insight-list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 10px;
      color: rgba(226,232,240,0.9);
      font-size: 14px;
    }
    .insight-list li {
      display: flex;
      justify-content: space-between;
      border-bottom: 1px dashed rgba(255,255,255,0.08);
      padding-bottom: 6px;
    }
    .mini-chart {
      flex: 1;
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(59,130,246,0.12), rgba(139,92,246,0.08));
      border: 1px solid rgba(255,255,255,0.06);
      padding: 12px;
      display: grid;
      grid-template-columns: repeat(auto-fit,minmax(8px,1fr));
      align-items: end;
      gap: 8px;
    }
    .mini-chart span {
      display: block;
      width: 100%;
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(167,139,250,1), rgba(59,130,246,0.6));
      transition: transform 0.3s ease;
    }
    .mini-chart span:hover { transform: translateY(-6px); }
    .insight-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(15,23,42,0.1), rgba(2,6,23,0.9));
      opacity: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
    .insight-card:hover .insight-overlay {
      opacity: 1;
      pointer-events: auto;
    }
    .insight-overlay button {
      border: 1px solid rgba(255,255,255,0.4);
      background: rgba(15,23,42,0.7);
      color: white;
      padding: 10px 18px;
      border-radius: 999px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      backdrop-filter: blur(6px);
    }
    .segments-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
    }
    .segments-grid div {
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(15,23,42,0.8);
      padding: 12px;
      text-align: center;
    }
    .map-section {
      margin-top: 48px;
      border-radius: 32px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(5,8,20,0.8);
      box-shadow: 0 30px 60px rgba(0,0,0,0.6);
      padding: 32px;
    }
    .forecast-section {
      margin-top: 32px;
      border-radius: 32px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(6,10,24,0.85);
      box-shadow: 0 30px 60px rgba(0,0,0,0.6);
      padding: 32px;
    }
    #geoMap {
      width: 100%;
      min-height: 420px;
    }
    #forecastChart {
      width: 100%;
      min-height: 360px;
    }
    .interactive-chart {
      width: 100%;
      height: 320px;
    }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      backdrop-filter: blur(6px);
    }
    .modal {
      width: min(960px, 90vw);
      background: rgba(8,13,30,0.95);
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,0.12);
      padding: 24px;
      box-shadow: 0 30px 60px rgba(0,0,0,0.6);
    }
    .modal header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .modal header h4 {
      margin: 0;
      font-size: 22px;
    }
    .modal-close {
      border: none;
      background: rgba(255,255,255,0.08);
      color: white;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      cursor: pointer;
    }
    .plot-loading,
    #summaryLoading {
      display: none;
      align-items: center;
      justify-content: center;
      border-radius: 22px;
      border: 1px dashed rgba(255,255,255,0.12);
      padding: 24px;
      color: rgba(221,214,254,0.8);
      font-weight: 500;
    }
    .spinner {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 3px solid rgba(255,255,255,0.15);
      border-top-color: #a855f7;
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-message {
      display: none;
      padding: 14px;
      border-radius: 16px;
      background: rgba(239,68,68,0.12);
      border: 1px solid rgba(248,113,113,0.3);
      color: #fecaca;
      font-size: 14px;
    }
    .customer-audio-card { margin-top: 40px; }
    .customer-audio-header {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
    }
    .customer-audio-header h3 {
      margin: 0;
      font-size: 26px;
    }
    .customer-input-row {
      margin-top: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .customer-status {
      margin-top: 14px;
      border-radius: 16px;
      padding: 14px 16px;
      background: rgba(59,130,246,0.08);
      border: 1px solid rgba(59,130,246,0.25);
      color: #bfdbfe;
      font-size: 14px;
    }
    .customer-status.error {
      background: rgba(239,68,68,0.12);
      border-color: rgba(248,113,113,0.35);
      color: #fecaca;
    }
    .customer-insight-body {
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .customer-identity {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
      justify-content: space-between;
      align-items: flex-start;
    }
    .customer-metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }
    .customer-metric {
      border-radius: 20px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.06);
      padding: 16px;
    }
    .customer-metric strong { font-size: 24px; font-weight: 600; }
    .eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 11px;
      color: rgba(148,163,184,0.9);
      margin: 0 0 6px;
    }
    .customer-muted { color: rgba(226,232,240,0.75); margin: 0; }
    .customer-visuals {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 18px;
    }
    .customer-chart-card,
    .customer-top-products-card {
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(6,11,25,0.7);
      padding: 16px;
      min-height: 220px;
    }
    .mini-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(226,232,240,0.75);
      margin-bottom: 10px;
    }
    .empty-state {
      font-size: 14px;
      color: rgba(148,163,184,0.85);
      text-align: center;
      padding: 30px 10px;
      border-radius: 16px;
      border: 1px dashed rgba(148,163,184,0.3);
    }
    .customer-top-products-card ul {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .customer-top-products-card li {
      border-radius: 16px;
      padding: 12px;
      background: rgba(15,23,42,0.7);
      border: 1px solid rgba(255,255,255,0.06);
    }
    .customer-top-products-card li strong { display: block; font-size: 15px; }
    .customer-top-products-card li span { color: rgba(148,163,184,0.85); font-size: 13px; }
    .customer-narrative {
      border-radius: 18px;
      padding: 18px;
      background: rgba(59,130,246,0.1);
      border: 1px solid rgba(59,130,246,0.25);
      font-size: 15px;
      line-height: 1.6;
    }
    .customer-highlight-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    .customer-highlight-list li {
      border-radius: 16px;
      padding: 14px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      display: flex;
      gap: 10px;
      font-size: 14px;
      color: rgba(229,231,235,0.9);
    }
    .customer-highlight-list i {
      color: #fcd34d;
      margin-top: 2px;
    }
    .customer-json-panel summary {
      cursor: pointer;
      color: rgba(191,219,254,0.9);
      font-size: 14px;
    }
    .json-viewer {
      margin-top: 10px;
      padding: 16px;
      border-radius: 16px;
      background: rgba(15,23,42,0.75);
      border: 1px solid rgba(255,255,255,0.05);
      max-height: 240px;
      overflow: auto;
      font-family: 'SFMono-Regular', Consolas, monospace;
      font-size: 13px;
      color: #cbd5f5;
    }
    .voice-btn { display:flex; align-items:center; gap:10px; }
    @media (max-width: 640px) {
      .page { padding: 24px 16px 60px; }
      .card, .map-section { padding: 20px; }
    }
  </style>
</head>
<body class="bg-blobs">
  <div class="page">
    <header class="hero">
      <div class="hero-content">
        <img src="/agent_outputs/Pepsico-logo-footer.png" alt="PepsiCo" style="height:72px; margin-bottom:12px;">
        <h1>Sales Analytics Agent</h1>
        <p>PepsiCo insights assistant powering revenue, margin, and ROI decisions</p>
      </div>
    </header>

    <section class="grid-two">
      <div class="card">
        <h2><i class="fas fa-question-circle" style="color:#c4b5fd;"></i> Query</h2>
        <div style="margin-top:18px; display:flex; flex-direction:column; gap:18px;">
          <div>
            <label>Your Question</label>
            <textarea id="question" placeholder="Ask about trends, margins, anomalies, seasonality, etc.">What are the revenue and margin trends?</textarea>
          </div>
          <div>
            <label>Date Range</label>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap:12px; margin-top:8px;">
              <input type="date" id="startDate" value="2015-01-01" />
              <input type="date" id="endDate" value="2016-12-31" />
            </div>
          </div>
          <div class="error-message" id="error"></div>
          <div style="display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:12px;">
            <button id="ask" class="btn-primary"><i class="fas fa-robot" style="margin-right:10px;"></i>Ask Agent</button>
            <button id="showroi" class="btn-secondary"><i class="fas fa-chart-bar" style="margin-right:10px;"></i>Plot Only</button>
            <button id="toggleAudio" class="btn-secondary"><i class="fas fa-microphone"></i> Voice Agent</button>
            <button id="loading" class="btn-primary" style="display:none; align-items:center; justify-content:center;">
              <span class="spinner"></span>Analyzing...
            </button>
          </div>
          <div id="summaryLoading" class="plot-loading"><span class="spinner"></span>Processing...</div>
          <div id="summary" style="display:none; border-radius:22px; background:rgba(15,23,42,0.7); padding:20px; line-height:1.6;"></div>
          <div id="audioStatus" style="display:none; margin-top:10px; border-radius:16px; border:1px solid rgba(255,255,255,0.1); padding:12px; background:rgba(15,23,42,0.6); font-size:14px;"></div>
          <div id="audioTranscripts" style="display:none; margin-top:10px; border-radius:16px; border:1px solid rgba(255,255,255,0.08); padding:12px; background:rgba(15,23,42,0.4); min-height:60px; font-size:14px; line-height:1.6;"></div>
          <audio id="assistantAudio" autoplay playsinline style="display:none;"></audio>
        </div>
      </div>

      <div class="card">
        <h2><i class="fas fa-info-circle" style="color:#93c5fd;"></i> Info</h2>
        <div style="display:flex; flex-direction:column; gap:18px; margin-top:18px;">
          <div style="display:flex; gap:12px;">
            <div style="font-size:30px;">ðŸ“Š</div>
            <div>
              <p style="margin:0; font-weight:600;">Data Coverage</p>
              <p style="margin:4px 0 0; color:rgba(226,232,240,0.8); font-size:14px;">18 months of real sales data (Jan 2015 - Jun 2016)</p>
            </div>
          </div>
          <div>
            <p style="margin:0; font-weight:600;">Analysis Includes:</p>
            <ul style="margin:10px 0 0 18px; color:rgba(226,232,240,0.84); line-height:1.6;">
              <li>Monthly revenue trends</li>
              <li>Cost of goods sold (COGS)</li>
              <li>Gross margin calculations</li>
              <li>ROI (Return on Investment)</li>
              <li>Trend detection & anomalies</li>
            </ul>
          </div>
          <div style="display:flex; gap:12px;">
            <div style="font-size:30px;">ðŸ¤–</div>
            <div>
              <p style="margin:0; font-weight:600;">LLM-Powered</p>
              <p style="margin:4px 0 0; color:rgba(226,232,240,0.8); font-size:14px;">OpenAI GPT-4 provides intelligent summaries and insights</p>
            </div>
          </div>
          <div style="display:grid; grid-template-columns: repeat(auto-fit,minmax(140px,1fr)); gap:12px;">
            <div style="border-radius:18px; padding:16px; background:rgba(255,255,255,0.04); text-align:center;">
              <p style="margin:0; text-transform:uppercase; font-size:11px; letter-spacing:0.1em; color:rgba(148,163,184,0.9);">Gross Margin</p>
              <p id="grossMarginMetric" style="margin:6px 0 0; font-size:24px; font-weight:600;">--</p>
            </div>
            <div style="border-radius:18px; padding:16px; background:rgba(255,255,255,0.04); text-align:center;">
              <p style="margin:0; text-transform:uppercase; font-size:11px; letter-spacing:0.1em; color:rgba(148,163,184,0.9);">ROI Trend</p>
              <p id="roiTrendMetric" style="margin:6px 0 0; font-size:24px; font-weight:600;">--</p>
            </div>
          </div>
          <div style="border-radius:20px; overflow:hidden; border:1px solid rgba(255,255,255,0.08); position:relative; min-height:240px;">
            <div id="roiChart" class="interactive-chart"></div>
            <div id="roiChartLoading" class="plot-loading" style="min-height:200px;"><span class="spinner"></span>Loading interactive chart...</div>
          </div>
        </div>
      </div>
    </section>

    <section class="quick-section">
      <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:baseline; justify-content:space-between;">
        <div>
          <h3>Quick Win Dashboards</h3>
          <p style="margin:6px 0 0; color:rgba(228,233,247,0.75);">Top customers, products, salespeople, and customer segments for the selected date range.</p>
        </div>
        <button id="refreshInsights" class="btn-primary" style="padding:10px 24px; font-size:15px; display:flex; align-items:center; gap:10px;"><i class="fas fa-sync"></i> Refresh Insights</button>
      </div>
      <div class="quick-grid">
        <div class="insight-card" data-insight="topCustomers">
          <div class="insight-overlay"><button data-detail="topCustomers"><i class="fas fa-chart-column"></i> Open Chart</button></div>
          <div class="insight-header">
            <div><i class="fas fa-users" style="color:#c4b5fd; margin-right:8px;"></i> Top Customers</div>
            <span id="topCustomersStatus" style="font-size:12px; color:rgba(226,232,240,0.7);">Idle</span>
          </div>
          <ul class="insight-list" id="topCustomersList"><li>Click refresh to load data</li></ul>
          <div id="topCustomersChart" class="mini-chart"></div>
        </div>
        <div class="insight-card" data-insight="topProducts">
          <div class="insight-overlay"><button data-detail="topProducts"><i class="fas fa-chart-simple"></i> Open Chart</button></div>
          <div class="insight-header">
            <div><i class="fas fa-boxes" style="color:#93c5fd; margin-right:8px;"></i> Top Products</div>
            <span id="topProductsStatus" style="font-size:12px; color:rgba(226,232,240,0.7);">Idle</span>
          </div>
          <ul class="insight-list" id="topProductsList"><li>Click refresh to load data</li></ul>
          <div id="topProductsChart" class="mini-chart"></div>
        </div>
        <div class="insight-card" data-insight="salespeople">
          <div class="insight-overlay"><button data-detail="salespeople"><i class="fas fa-user-tie"></i> Open Chart</button></div>
          <div class="insight-header">
            <div><i class="fas fa-id-badge" style="color:#fde68a; margin-right:8px;"></i> Salesperson Leaders</div>
            <span id="salespeopleStatus" style="font-size:12px; color:rgba(226,232,240,0.7);">Idle</span>
          </div>
          <ul class="insight-list" id="salespeopleList"><li>Click refresh to load data</li></ul>
          <div id="salespeopleChart" class="mini-chart"></div>
        </div>
        <div class="insight-card" data-insight="segments">
          <div class="insight-overlay"><button data-detail="segments"><i class="fas fa-circle-notch"></i> Open Chart</button></div>
          <div class="insight-header">
            <div><i class="fas fa-layer-group" style="color:#f9a8d4; margin-right:8px;"></i> Customer Segments</div>
            <span id="segmentsStatus" style="font-size:12px; color:rgba(226,232,240,0.7);">Idle</span>
          </div>
          <ul class="insight-list" id="segmentsList"><li>Click refresh to load data</li></ul>
          <div id="segmentsChart" class="mini-chart"></div>
        </div>
      </div>
    </section>

    <section class="card customer-audio-card">
      <div class="customer-audio-header">
        <div>
          <h3>Audio LLM Â· Customer Spotlight</h3>
          <p style="margin:6px 0 0; color:rgba(226,232,240,0.78);">
            Speak or type a customer name to pull their KPIs, visualize history, and hear LLM commentary.
          </p>
        </div>
        <div style="display:flex; gap:12px; flex-wrap:wrap;">
          <button id="customerVoiceBtn" class="btn-secondary voice-btn"><i class="fas fa-wave-square"></i> Speak Name</button>
          <button id="customerAnalyzeBtn" class="btn-primary"><i class="fas fa-chart-line"></i> Analyze Customer</button>
        </div>
      </div>
      <div class="customer-input-row">
        <label for="customerNameInput">Customer Name</label>
        <input type="text" id="customerNameInput" placeholder="e.g. Tailspin Toys (Head Office)" />
      </div>
      <div id="customerInsightStatus" class="customer-status">Say or enter a customer to analyze.</div>
      <div id="customerInsightBody" class="customer-insight-body" style="display:none;">
        <div class="customer-identity">
          <div>
            <p class="eyebrow">Customer</p>
            <h4 id="customerInsightTitle" style="margin:0;">--</h4>
            <p id="customerInsightMeta" class="customer-muted">--</p>
          </div>
          <div>
            <p class="eyebrow">Category</p>
            <p id="customerInsightCategory" class="customer-muted">--</p>
          </div>
        </div>
        <div class="customer-metrics-grid">
          <div class="customer-metric">
            <p class="eyebrow">Revenue</p>
            <strong id="customerRevenueMetric">--</strong>
          </div>
          <div class="customer-metric">
            <p class="eyebrow">Profit</p>
            <strong id="customerProfitMetric">--</strong>
          </div>
          <div class="customer-metric">
            <p class="eyebrow">Invoices</p>
            <strong id="customerInvoiceMetric">--</strong>
          </div>
        </div>
        <div class="customer-visuals">
          <div class="customer-chart-card">
            <div class="mini-title">Monthly Revenue & Profit</div>
            <div id="customerInsightChartEmpty" class="empty-state">Load a customer to see performance history.</div>
            <div id="customerInsightChart" class="interactive-chart" style="display:none;"></div>
          </div>
          <div class="customer-top-products-card">
            <div class="mini-title">Top Products</div>
            <ul id="customerTopProductsList"><li>Load a customer to see their product mix.</li></ul>
          </div>
        </div>
        <div class="customer-narrative" id="customerInsightNarrative"></div>
        <ul class="customer-highlight-list" id="customerInsightHighlights" style="display:none;"></ul>
        <details class="customer-json-panel">
          <summary>Data Snapshot</summary>
          <pre id="customerInsightJson" class="json-viewer">{}</pre>
        </details>
      </div>
    </section>

    <section class="map-section">
      <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; margin-bottom:18px;">
        <div>
          <h3 style="margin:0; font-size:28px;">Global Sales Heatmap</h3>
          <p style="margin:6px 0 0; color:rgba(226,232,240,0.78);">Visualize where customers are spending the most.</p>
        </div>
        <button id="refreshGeo" class="btn-primary" style="display:flex; align-items:center; gap:10px; padding:10px 24px;"><i class="fas fa-globe"></i> Refresh Map</button>
      </div>
      <div id="geoMapLoading" class="plot-loading" style="min-height:220px;"><span class="spinner"></span>Loading geographic data...</div>
      <div id="geoMap"></div>
    </section>

    <section class="forecast-section">
      <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px;">
        <div>
          <h3 style="margin:0; font-size:28px;">Demand Forecasts</h3>
          <p id="forecastSubtitle" style="margin:6px 0 0; color:rgba(226,232,240,0.78);">Predict upcoming demand for top products.</p>
        </div>
        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
          <select id="forecastProduct" style="min-width:220px;">
            <option value="">Auto (Top Seller)</option>
          </select>
          <button id="refreshForecast" class="btn-primary" style="display:flex; align-items:center; gap:10px; padding:12px 22px;">
            <i class="fas fa-chart-area"></i> Refresh Forecast
          </button>
        </div>
      </div>
      <div id="forecastChartLoading" class="plot-loading" style="min-height:220px;"><span class="spinner"></span>Building forecast...</div>
      <div id="forecastChart" class="interactive-chart"></div>
      <p id="forecastExplanation" style="margin-top:12px; color:rgba(226,232,240,0.75);"></p>
    </section>

    
  </div>

  <div id="detailModal" class="modal-backdrop">
    <div class="modal">
      <header>
        <h4 id="modalTitle">Insight Detail</h4>
        <button class="modal-close" id="modalClose">&times;</button>
      </header>
      <div id="modalChart" style="width:100%; height:420px;"></div>
    </div>
  </div>

  <script>
    const questionEl = document.getElementById('question');
    const startDateEl = document.getElementById('startDate');
    const endDateEl = document.getElementById('endDate');
    const askBtn = document.getElementById('ask');
    const loadingBtn = document.getElementById('loading');
    const showroiBtn = document.getElementById('showroi');
    const summaryEl = document.getElementById('summary');
    const summaryLoadingEl = document.getElementById('summaryLoading');
    const roiChartEl = document.getElementById('roiChart');
    const roiChartLoadingEl = document.getElementById('roiChartLoading');
    const grossMarginMetric = document.getElementById('grossMarginMetric');
    const roiTrendMetric = document.getElementById('roiTrendMetric');
    const errorEl = document.getElementById('error');
    const refreshInsightsBtn = document.getElementById('refreshInsights');
    const refreshGeoBtn = document.getElementById('refreshGeo');
    const geoMapEl = document.getElementById('geoMap');
    const geoMapLoadingEl = document.getElementById('geoMapLoading');
    const detailModal = document.getElementById('detailModal');
    const modalClose = document.getElementById('modalClose');
    const modalTitle = document.getElementById('modalTitle');
    const modalChart = document.getElementById('modalChart');
    const forecastProductSelect = document.getElementById('forecastProduct');
    const refreshForecastBtn = document.getElementById('refreshForecast');
    const forecastChart = document.getElementById('forecastChart');
    const forecastChartLoading = document.getElementById('forecastChartLoading');
    const forecastSubtitle = document.getElementById('forecastSubtitle');
    const forecastExplanation = document.getElementById('forecastExplanation');
    const toggleAudioBtn = document.getElementById('toggleAudio');
    const audioStatusEl = document.getElementById('audioStatus');
    const audioTranscriptsEl = document.getElementById('audioTranscripts');
    const assistantAudioEl = document.getElementById('assistantAudio');
    const customerNameInput = document.getElementById('customerNameInput');
    const customerVoiceBtn = document.getElementById('customerVoiceBtn');
    const customerAnalyzeBtn = document.getElementById('customerAnalyzeBtn');
    const customerInsightStatus = document.getElementById('customerInsightStatus');
    const customerInsightBody = document.getElementById('customerInsightBody');
    const customerInsightTitle = document.getElementById('customerInsightTitle');
    const customerInsightMeta = document.getElementById('customerInsightMeta');
    const customerInsightCategory = document.getElementById('customerInsightCategory');
    const customerRevenueMetricEl = document.getElementById('customerRevenueMetric');
    const customerProfitMetricEl = document.getElementById('customerProfitMetric');
    const customerInvoiceMetricEl = document.getElementById('customerInvoiceMetric');
    const customerInsightChartEl = document.getElementById('customerInsightChart');
    const customerInsightChartEmpty = document.getElementById('customerInsightChartEmpty');
    const customerTopProductsList = document.getElementById('customerTopProductsList');
    const customerInsightNarrative = document.getElementById('customerInsightNarrative');
    const customerInsightHighlights = document.getElementById('customerInsightHighlights');
    const customerInsightJson = document.getElementById('customerInsightJson');
    const customerAnalyzeDefaultLabel = customerAnalyzeBtn ? customerAnalyzeBtn.innerHTML : '';

    const insightStore = {};
    let forecastInitialized = false;
    let audioActive = false;
    let audioPeer = null;
    let audioStream = null;
    let audioTranscriptBuffer = '';
    let customerInsightLoading = false;
    const currencyFormatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
    const numberFormatter = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 });

    function formatCurrency(value) {
      const num = Number(value);
      if (!Number.isFinite(num)) return '--';
      return currencyFormatter.format(num);
    }

    function formatNumber(value) {
      const num = Number(value);
      if (!Number.isFinite(num)) return '--';
      return numberFormatter.format(num);
    }

    function setCustomerStatus(message, isError = false) {
      if (!customerInsightStatus) return;
      customerInsightStatus.textContent = message;
      customerInsightStatus.classList.toggle('error', !!isError);
    }

    function renderCustomerChart(monthly = []) {
      if (!customerInsightChartEl) return;
      if (!monthly.length) {
        customerInsightChartEl.style.display = 'none';
        if (customerInsightChartEmpty) customerInsightChartEmpty.style.display = 'flex';
        customerInsightChartEl.innerHTML = '';
        return;
      }
      const x = monthly.map(row => row.month);
      const revenue = monthly.map(row => Number(row.revenue || 0));
      const profit = monthly.map(row => Number(row.profit || 0));
      const traces = [
        { x, y: revenue, name: 'Revenue', type: 'scatter', mode: 'lines+markers', line: { color: '#8b5cf6', width: 3 } },
        { x, y: profit, name: 'Profit', type: 'scatter', mode: 'lines+markers', line: { color: '#22d3ee', width: 3, dash: 'dot' } }
      ];
      Plotly.newPlot(customerInsightChartEl, traces, {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        font: { color: '#e2e8f0' },
        margin: { l: 50, r: 20, t: 20, b: 40 },
        hovermode: 'x unified',
        height: 260
      }, { displayModeBar: false, responsive: true });
      customerInsightChartEl.style.display = 'block';
      if (customerInsightChartEmpty) customerInsightChartEmpty.style.display = 'none';
    }

    function renderCustomerTopProducts(products = []) {
      if (!customerTopProductsList) return;
      if (!products.length) {
        customerTopProductsList.innerHTML = '<li>No product sales found in this range.</li>';
        return;
      }
      customerTopProductsList.innerHTML = products.map(p => `
        <li>
          <strong>${p.name}</strong>
          <span>${formatCurrency(p.revenue)} Â· ${formatNumber(p.units)} units Â· Profit ${formatCurrency(p.profit)}</span>
        </li>
      `).join('');
    }

    function updateCustomerJson(payload) {
      if (!customerInsightJson) return;
      customerInsightJson.textContent = JSON.stringify({
        customer: payload.customer,
        metrics: payload.metrics,
        monthly: payload.monthly,
        top_products: payload.top_products
      }, null, 2);
    }

    function renderCustomerInsight(payload) {
      if (!payload) return;
      const customer = payload.customer || {};
      const metrics = payload.metrics || {};
      if (customerInsightBody) customerInsightBody.style.display = 'flex';
      if (customerInsightTitle) customerInsightTitle.textContent = customer.name || 'Unnamed Customer';
      const locationBits = [];
      if (customer.location?.city) locationBits.push(customer.location.city);
      if (customer.location?.state) locationBits.push(customer.location.state);
      if (customer.location?.country) locationBits.push(customer.location.country);
      if (customerInsightMeta) customerInsightMeta.textContent = locationBits.length ? locationBits.join(', ') : 'Location unavailable';
      if (customerInsightCategory) customerInsightCategory.textContent = customer.category || 'Uncategorized';
      if (customerRevenueMetricEl) customerRevenueMetricEl.textContent = formatCurrency(metrics.revenue);
      if (customerProfitMetricEl) customerProfitMetricEl.textContent = formatCurrency(metrics.profit);
      const invoiceCount = metrics.invoices ?? metrics.orders ?? metrics.order_count;
      if (customerInvoiceMetricEl) customerInvoiceMetricEl.textContent = formatNumber(invoiceCount);
      if (customerInsightNarrative) customerInsightNarrative.textContent = payload.insight || 'No LLM narrative available.';

      if (customerInsightHighlights) {
        if (payload.highlights && payload.highlights.length) {
          customerInsightHighlights.innerHTML = payload.highlights.map(h => `<li><i class="fas fa-star"></i><span>${h}</span></li>`).join('');
          customerInsightHighlights.style.display = 'grid';
        } else {
          customerInsightHighlights.style.display = 'none';
        }
      }

      renderCustomerChart(payload.monthly || []);
      renderCustomerTopProducts(payload.top_products || []);
      updateCustomerJson(payload);
    }

    async function loadCustomerInsight(nameOverride) {
      if (!customerNameInput || customerInsightLoading) return;
      const resolvedName = (nameOverride || customerNameInput.value || '').trim();
      if (!resolvedName) {
        setCustomerStatus('Provide a customer name first.', true);
        return;
      }
      customerNameInput.value = resolvedName;
      customerInsightLoading = true;
      setCustomerStatus('Contacting the PepsiCoPilot insight agent...', false);
      if (customerAnalyzeBtn) {
        customerAnalyzeBtn.disabled = true;
        customerAnalyzeBtn.innerHTML = '<span class="spinner"></span>Analyzing...';
      }
      try {
        const payload = {
          customer_name: resolvedName,
          start_date: startDateEl?.value || '2015-01-01',
          end_date: endDateEl?.value || '2016-12-31'
        };
        const response = await fetch('/api/customer-intent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) {
          const errPayload = await response.json().catch(() => ({}));
          throw new Error(errPayload.detail || `Unable to fetch insight (HTTP ${response.status})`);
        }
        const data = await response.json();
        renderCustomerInsight(data);
        setCustomerStatus(`Insights refreshed for ${data?.customer?.name || resolvedName}.`, false);
      } catch (err) {
        setCustomerStatus(err.message || 'Unable to load customer insight.', true);
        if (customerInsightBody) customerInsightBody.style.display = 'none';
      } finally {
        customerInsightLoading = false;
        if (customerAnalyzeBtn) {
          customerAnalyzeBtn.disabled = false;
          customerAnalyzeBtn.innerHTML = customerAnalyzeDefaultLabel || '<i class="fas fa-chart-line"></i> Analyze Customer';
        }
      }
    }

    function captureCustomerName() {
      if (!customerNameInput) return;
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        setCustomerStatus('Speech recognition is not supported in this browser. Please type the customer name.', true);
        return;
      }
      const recognition = new SpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.start();
      setCustomerStatus('Listening for a customer name...', false);
      recognition.onresult = event => {
        const transcript = event.results?.[0]?.[0]?.transcript?.trim();
        if (transcript) {
          customerNameInput.value = transcript;
          setCustomerStatus(`Heard â€œ${transcript}â€. Generating insights...`, false);
          loadCustomerInsight(transcript);
        } else {
          setCustomerStatus('Could not capture the customer name. Please try again.', true);
        }
      };
      recognition.onerror = evt => {
        setCustomerStatus(`Audio capture error: ${evt.error || 'unknown'}`, true);
      };
    }

    const quickInsights = [
      {
        key: 'topCustomers',
        name: 'Top Customers',
        endpoint: '/api/top-customers',
        listEl: document.getElementById('topCustomersList'),
        statusEl: document.getElementById('topCustomersStatus'),
        chartEl: document.getElementById('topCustomersChart'),
        formatter: payload => {
          const rows = (payload.data || []).slice(0, 5);
          if (!rows.length) return ['No customers found'];
          return rows.map((row, idx) => ({
            label: `${idx + 1}. ${row.CustomerName}`,
            value: currency(row.total_revenue)
          }));
        },
        getSeries: payload => (payload.data || []).map(row => ({ label: row.CustomerName, value: row.total_revenue })),
        detailType: 'bar'
      },
      {
        key: 'topProducts',
        name: 'Top Products',
        endpoint: '/api/top-products',
        listEl: document.getElementById('topProductsList'),
        statusEl: document.getElementById('topProductsStatus'),
        chartEl: document.getElementById('topProductsChart'),
        formatter: payload => {
          const rows = (payload.data || []).slice(0, 5);
          if (!rows.length) return ['No products found'];
          return rows.map((row, idx) => ({
            label: `${idx + 1}. ${row.StockItemName}`,
            value: `${currency(row.total_revenue)} â€¢ ${row.total_units} units`
          }));
        },
        getSeries: payload => (payload.data || []).map(row => ({ label: row.StockItemName, value: row.total_revenue })),
        detailType: 'bar'
      },
      {
        key: 'salespeople',
        name: 'Salesperson Leaders',
        endpoint: '/api/salesperson-performance',
        listEl: document.getElementById('salespeopleList'),
        statusEl: document.getElementById('salespeopleStatus'),
        chartEl: document.getElementById('salespeopleChart'),
        formatter: payload => {
          const rows = (payload.data || []).slice(0, 5);
          if (!rows.length) return ['No salesperson data'];
          return rows.map((row, idx) => ({
            label: `${idx + 1}. ${row.salesperson || 'Unknown'}`,
            value: `${currency(row.total_revenue)} â€¢ ${Number(row.profit_margin_pct || 0).toFixed(1)}% margin`
          }));
        },
        getSeries: payload => (payload.data || []).map(row => ({ label: row.salesperson || 'Unknown', value: row.total_revenue })),
        detailType: 'bar'
      },
      {
        key: 'segments',
        name: 'Customer Segments',
        endpoint: '/api/customer-segmentation',
        listEl: document.getElementById('segmentsList'),
        statusEl: document.getElementById('segmentsStatus'),
        chartEl: document.getElementById('segmentsChart'),
        formatter: payload => {
          const summary = payload.summary || {};
          const segments = payload.data || {};
          const entries = Object.entries(summary.segments || {});
          if (!entries.length) return ['No segment data'];
          return entries.sort((a,b) => b[1]-a[1]).map(([segment, count]) => {
            const top = (segments[segment] || [])[0];
            return {
              label: `${segment} (${count})`,
              value: top ? `Top: ${top.CustomerName} (${currency(top.total_spent)})` : ''
            };
          });
        },
        getSeries: payload => {
          const summary = payload.summary || {};
          return Object.entries(summary.segments || {}).map(([segment, count]) => ({ label: segment, value: count }));
        },
        detailType: 'pie'
      }
    ];

    function currency(value) {
      const num = Number(value || 0);
      return '$' + num.toLocaleString('en-US', { maximumFractionDigits: 0 });
    }

    function populateForecastOptions() {
      if (!forecastProductSelect) return;
      const previous = forecastProductSelect.value;
      forecastProductSelect.innerHTML = '<option value=\"\">Auto (Top Seller)</option>';
      const store = insightStore['topProducts'];
      if (store && store.payload && Array.isArray(store.payload.data)) {
        store.payload.data.forEach(row => {
          const option = document.createElement('option');
          option.value = row.StockItemID;
          option.textContent = `${row.StockItemName} (${row.StockItemID})`;
          forecastProductSelect.appendChild(option);
        });
      }
      if (previous && [...forecastProductSelect.options].some(opt => opt.value === previous)) {
        forecastProductSelect.value = previous;
      }
    }

    async function loadRoiChart(startDate = startDateEl.value, endDate = endDateEl.value) {
      roiChartLoadingEl.style.display = 'flex';
      roiChartEl.innerHTML = '';
      try {
        const params = new URLSearchParams({ start_date: startDate, end_date: endDate });
        const res = await fetch(`/api/roi-data?${params.toString()}`);
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || `HTTP ${res.status}`);
        }
        const payload = await res.json();
        const rows = payload.data || [];
        const summary = payload.summary || {};
        if (grossMarginMetric) grossMarginMetric.textContent = summary.gross_margin_pct !== undefined ? `${summary.gross_margin_pct.toFixed(1)}%` : '--';
        if (roiTrendMetric) {
          const trend = summary.roi_trend_pct || 0;
          const sign = trend >= 0 ? '+' : '';
          roiTrendMetric.textContent = `${sign}${trend.toFixed(1)}%`;
        }
        if (!rows.length) {
          roiChartEl.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:20px;">No ROI data</div>';
          return;
        }
        const months = rows.map(r => new Date(r.month).toISOString().slice(0, 10));
        const traces = [
          { name: 'Revenue', x: months, y: rows.map(r => r.revenue), mode: 'lines+markers', line: { color: '#818cf8', width: 3 }, marker: { size: 6 } },
          { name: 'COGS', x: months, y: rows.map(r => r.cogs), mode: 'lines+markers', line: { color: '#fb7185', width: 3 }, marker: { size: 6 } },
          { name: 'Gross Margin', x: months, y: rows.map(r => r.gross_margin), mode: 'lines+markers', line: { color: '#2dd4bf', width: 3 }, marker: { size: 6 } }
        ];
        Plotly.newPlot(roiChartEl, traces, {
          paper_bgcolor: 'rgba(0,0,0,0)',
          plot_bgcolor: 'rgba(0,0,0,0)',
          margin: { l: 50, r: 20, t: 10, b: 50 },
          legend: { orientation: 'h', y: -0.2 },
          xaxis: { title: 'Month', gridcolor: 'rgba(255,255,255,0.05)' },
          yaxis: { title: 'Amount', gridcolor: 'rgba(255,255,255,0.05)' },
          font: { color: '#e5e7eb' },
          hovermode: 'x unified'
        }, { displayModeBar: false, responsive: true });
      } catch (err) {
        roiChartEl.innerHTML = `<div style="text-align:center;color:#fecaca;padding:20px;">Error loading chart: ${err.message}</div>`;
      } finally {
        roiChartLoadingEl.style.display = 'none';
      }
    }

    async function loadDemandForecast(stockItemId = forecastProductSelect?.value || '') {
      if (!forecastChart || !forecastChartLoading) return;
      forecastChartLoading.style.display = 'flex';
      forecastChart.innerHTML = '';
      if (forecastExplanation) forecastExplanation.textContent = '';
      try {
        const params = new URLSearchParams({
          start_date: startDateEl.value,
          end_date: endDateEl.value,
          months_ahead: 6
        });
        if (stockItemId) params.append('stock_item_id', stockItemId);
        const res = await fetch(`/api/demand-forecast?${params.toString()}`);
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || `HTTP ${res.status}`);
        }
        const payload = await res.json();
        const history = payload.history || [];
        const future = payload.forecast || [];
        if (!history.length) {
          forecastChart.innerHTML = '<div style=\"text-align:center;color:#94a3b8;padding:20px;\">No forecast data</div>';
          return;
        }
        forecastSubtitle.textContent = `Predicting demand for ${payload.stock_item?.name || 'top product'}`;
        if (forecastExplanation) {
          forecastExplanation.textContent = payload.explanation || '';
        }
        const historyMonths = history.map(r => r.month);
        const futureMonths = future.map(r => r.month);
        const lastHistoryMonth = historyMonths[historyMonths.length - 1];
        const lastHistoryValue = history[history.length - 1].units;
        const traces = [
          {
            name: 'Actual',
            x: historyMonths,
            y: history.map(r => r.units),
            mode: 'lines+markers',
            line: { color: '#38bdf8', width: 3 },
            marker: { size: 6 }
          },
          {
            name: 'Forecast',
            x: [lastHistoryMonth, ...futureMonths],
            y: [lastHistoryValue, ...future.map(r => r.units)],
            mode: 'lines+markers',
            line: { color: '#f472b6', width: 3, dash: 'dash' },
            marker: { size: 6 },
            fill: 'tozeroy',
            fillcolor: 'rgba(244,114,182,0.1)'
          }
        ];
        const lastHistory = historyMonths[historyMonths.length - 1];
        Plotly.newPlot(forecastChart, traces, {
          paper_bgcolor: 'rgba(0,0,0,0)',
          plot_bgcolor: 'rgba(0,0,0,0)',
          margin: { l: 60, r: 30, t: 10, b: 40 },
          xaxis: { title: 'Month', gridcolor: 'rgba(148,163,184,0.2)' },
          yaxis: { title: 'Units Sold', gridcolor: 'rgba(148,163,184,0.2)' },
          font: { color: '#e5e7eb' },
          hovermode: 'x unified',
          shapes: lastHistory ? [{
            type: 'line',
            x0: lastHistory,
            x1: lastHistory,
            y0: 0,
            y1: future.length ? Math.max(...future.map(f => f.units)) * 1.1 : Math.max(...history.map(h => h.units)),
            line: { color: 'rgba(255,255,255,0.2)', dash: 'dot' }
          }] : []
        }, { displayModeBar: false, responsive: true });
      } catch (err) {
        forecastChart.innerHTML = `<div style=\"text-align:center;color:#fecaca;padding:20px;\">Error loading forecast: ${err.message}</div>`;
      } finally {
        forecastChartLoading.style.display = 'none';
      }
    }

    function showError(msg) {
      errorEl.textContent = msg;
      errorEl.style.display = 'block';
      setTimeout(() => errorEl.style.display = 'none', 5000);
    }

    function hideError() { errorEl.style.display = 'none'; }

    askBtn.onclick = async () => {
      hideError();
      const q = questionEl.value.trim();
      if (!q) {
        showError('Please enter a question');
        return;
      }
      const startDate = startDateEl.value;
      const endDate = endDateEl.value;
      askBtn.style.display = 'none';
      showroiBtn.style.display = 'none';
      loadingBtn.style.display = 'flex';
      summaryLoadingEl.style.display = 'flex';
      summaryEl.style.display = 'none';
      try {
        const res = await fetch('/api/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question: q, start_date: startDate, end_date: endDate })
        });
        if (!res.ok) {
          const errData = await res.json();
          throw new Error(errData.detail || `HTTP ${res.status}`);
        }
        const data = await res.json();
        summaryLoadingEl.style.display = 'none';
        summaryEl.textContent = data.summary;
        summaryEl.style.display = 'block';
        loadRoiChart(startDate, endDate);
      } catch (err) {
        summaryLoadingEl.style.display = 'none';
        showError(`Error: ${err.message}`);
      } finally {
        loadingBtn.style.display = 'none';
        askBtn.style.display = 'block';
        showroiBtn.style.display = 'block';
      }
    };

    showroiBtn.onclick = () => {
      hideError();
      const startDate = startDateEl.value;
      const endDate = endDateEl.value;
      loadRoiChart(startDate, endDate);
    };

    function renderInsightList(el, items) {
      if (Array.isArray(items)) {
        el.innerHTML = items.map(item => typeof item === 'string'
          ? `<li>${item}</li>`
          : `<li><span>${item.label}</span><span>${item.value}</span></li>`).join('');
      } else {
        el.innerHTML = '<li>No data</li>';
      }
    }

    async function loadInsightCard(config) {
      config.statusEl.textContent = 'Loading...';
      renderInsightList(config.listEl, ['Loading...']);
      if (config.chartEl) config.chartEl.innerHTML = '<div style="width:100%;text-align:center;color:#e2e8f0;opacity:0.7;">Loadingâ€¦</div>';
      const params = new URLSearchParams({ start_date: startDateEl.value, end_date: endDateEl.value });
      try {
        const res = await fetch(`${config.endpoint}?${params.toString()}`);
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || `HTTP ${res.status}`);
        }
        const data = await res.json();
        renderInsightList(config.listEl, config.formatter(data));
        const series = config.getSeries ? config.getSeries(data).slice(0, 10) : [];
        if (config.chartEl) renderMiniChart(config.chartEl, series);
        insightStore[config.key] = { title: config.name, payload: data, series, detailType: config.detailType };
        config.statusEl.textContent = 'Updated';
      } catch (err) {
        renderInsightList(config.listEl, [`Error: ${err.message}`]);
        if (config.chartEl) config.chartEl.innerHTML = '<div style="text-align:center;color:#fecaca;">Error</div>';
        config.statusEl.textContent = 'Error';
      }
    }

    async function loadQuickInsights() {
      refreshInsightsBtn.disabled = true;
      await Promise.all(quickInsights.map(loadInsightCard));
      refreshInsightsBtn.disabled = false;
      populateForecastOptions();
      if (!forecastInitialized) {
        await loadDemandForecast();
        forecastInitialized = true;
      }
    }

    async function loadGeoMap() {
      refreshGeoBtn.disabled = true;
      geoMapLoadingEl.style.display = 'flex';
      geoMapEl.innerHTML = '';
      const params = new URLSearchParams({ start_date: startDateEl.value, end_date: endDateEl.value, limit: 200 });
      try {
        const res = await fetch(`/api/geo-sales?${params.toString()}`);
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || `HTTP ${res.status}`);
        }
        const payload = await res.json();
        const points = (payload.data || []).filter(p => p.latitude !== null && p.longitude !== null);
        if (!points.length) {
          geoMapEl.innerHTML = '<div style="text-align:center;padding:40px;color:#e2e8f0;">No geographic data available.</div>';
        } else {
          const trace = {
            type: 'scattergeo',
            mode: 'markers',
            lon: points.map(p => p.longitude),
            lat: points.map(p => p.latitude),
            text: points.map(p => `${p.CityName}, ${p.CountryName}<br>Revenue: ${currency(p.total_revenue)}`),
            marker: {
              size: points.map(p => Math.max(8, Math.sqrt(p.total_revenue) / 200)),
              color: points.map(p => p.total_revenue),
              colorscale: 'Viridis',
              colorbar: { title: 'Revenue' },
              opacity: 0.85
            },
            hovertemplate: '%{text}<extra></extra>'
          };
          const layout = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            margin: { l:0, r:0, t:0, b:0 },
            geo: {
              scope: 'usa',
              projection: { type: 'albers usa' },
              showland: true,
              landcolor: '#111827',
              bgcolor: 'rgba(0,0,0,0)'
            }
          };
          Plotly.newPlot(geoMapEl, [trace], layout, { displayModeBar: false, responsive: true });
        }
      } catch (err) {
        geoMapEl.innerHTML = `<div style="text-align:center;padding:40px;color:#fecaca;">Error loading map: ${err.message}</div>`;
      } finally {
        geoMapLoadingEl.style.display = 'none';
        refreshGeoBtn.disabled = false;
      }
    }

    function renderMiniChart(el, series) {
      if (!el) return;
      if (!series.length) {
        el.innerHTML = '<div style="width:100%;text-align:center;color:#94a3b8;">No data</div>';
        return;
      }
      const max = Math.max(...series.map(s => s.value));
      el.innerHTML = series.slice(0, 12).map(s => {
        const pct = max ? (s.value / max) * 100 : 0;
        return `<span style="height:${pct || 4}%" title="${s.label}"></span>`;
      }).join('');
    }

    function openDetailModal(key) {
      const store = insightStore[key];
      if (!store || !store.series || !store.series.length) {
        showError('Load the insight first before opening its chart.');
        return;
      }
      modalTitle.textContent = store.title;
      detailModal.style.display = 'flex';
      const labels = store.series.map(s => s.label);
      const values = store.series.map(s => s.value);
      let trace;
      if (store.detailType === 'pie') {
        trace = { type: 'pie', labels, values, textinfo: 'label+percent', hole: 0.4 };
      } else {
        trace = {
          type: 'bar',
          x: values,
          y: labels,
          orientation: 'h',
          marker: { color: '#8b5cf6' }
        };
      }
      Plotly.newPlot(modalChart, [trace], {
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        margin: { l: 120, r: 20, t: 20, b: 40 },
        font: { color: 'white' }
      }, { displayModeBar: false, responsive: true });
    }

    function closeDetailModal() {
      detailModal.style.display = 'none';
    }

    document.querySelectorAll('[data-detail]').forEach(btn => {
      btn.addEventListener('click', e => {
        e.stopPropagation();
        openDetailModal(btn.dataset.detail);
      });
    });

    modalClose.addEventListener('click', closeDetailModal);
    detailModal.addEventListener('click', e => { if (e.target === detailModal) closeDetailModal(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeDetailModal(); });
    if (refreshForecastBtn) refreshForecastBtn.addEventListener('click', () => loadDemandForecast());
    if (forecastProductSelect) forecastProductSelect.addEventListener('change', () => loadDemandForecast());

    refreshInsightsBtn.addEventListener('click', loadQuickInsights);
    refreshGeoBtn.addEventListener('click', loadGeoMap);
    window.addEventListener('load', () => {
      loadQuickInsights();
      loadGeoMap();
      loadRoiChart();
    });

    async function initAudioSession() {
      if (!navigator.mediaDevices?.getUserMedia) {
        if (audioStatusEl) {
          audioStatusEl.style.display = 'block';
          audioStatusEl.textContent = 'Microphone access is not supported in this browser.';
        }
        return;
      }
      const startDate = startDateEl?.value || '2015-01-01';
      const endDate = endDateEl?.value || '2016-12-31';
      try {
        if (audioStatusEl) {
          audioStatusEl.style.display = 'block';
          audioStatusEl.textContent = 'Requesting audio session token...';
        }
        audioTranscriptBuffer = '';
        if (audioTranscriptsEl) {
          audioTranscriptsEl.style.display = 'block';
          audioTranscriptsEl.textContent = '';
        }
        const tokenRes = await fetch('/api/audio-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ start_date: startDate, end_date: endDate })
        });
        if (!tokenRes.ok) throw new Error(`HTTP ${tokenRes.status}`);
        const tokenPayload = await tokenRes.json();
        const clientSecret = tokenPayload?.client_secret?.value || tokenPayload?.client_secret;
        const model = tokenPayload?.model || 'gpt-4o-realtime-preview';
        const kickoffPrompt = tokenPayload?.pepsico_kickoff || '';
        if (!clientSecret) throw new Error('Missing client secret');

        if (audioStatusEl) audioStatusEl.textContent = 'Initializing microphone...';
        audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });

        const pc = new RTCPeerConnection();
        audioStream.getTracks().forEach(track => pc.addTrack(track, audioStream));
        pc.ontrack = event => {
          if (assistantAudioEl) {
            assistantAudioEl.srcObject = event.streams[0];
            assistantAudioEl.play().catch(() => {});
          }
        };
        pc.onconnectionstatechange = () => {
          if (audioStatusEl) audioStatusEl.textContent = `Connection: ${pc.connectionState}`;
        };

        const dataChannel = pc.createDataChannel('oai-events');
        dataChannel.onopen = () => {
          if (kickoffPrompt) {
            try {
              dataChannel.send(JSON.stringify({
                type: 'response.create',
                response: {
                  instructions: kickoffPrompt
                }
              }));
            } catch (err) {
              console.warn('Unable to send kickoff prompt', err);
            }
          }
        };
        dataChannel.onmessage = event => {
          if (!audioTranscriptsEl || !event.data) return;
          try {
            const parsed = JSON.parse(event.data);
            if (parsed.type === 'response.output_text.delta' && parsed.delta) {
              audioTranscriptBuffer += parsed.delta;
              audioTranscriptsEl.textContent = audioTranscriptBuffer;
            } else if (parsed.type === 'response.completed') {
              audioTranscriptBuffer += '\n';
            }
          } catch {
            audioTranscriptsEl.textContent = event.data;
          }
        };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await new Promise(resolve => {
          pc.onicecandidate = event => {
            if (!event.candidate) resolve();
          };
        });

        const realtimeResp = await fetch(`https://api.openai.com/v1/realtime?model=${encodeURIComponent(model)}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${clientSecret}`,
            'Content-Type': 'application/sdp'
          },
          body: pc.localDescription.sdp
        });
        if (!realtimeResp.ok) throw new Error(`Realtime connect failed: ${realtimeResp.status}`);
        const answerSDP = await realtimeResp.text();
        await pc.setRemoteDescription({ type: 'answer', sdp: answerSDP });

        audioPeer = pc;
        audioActive = true;
        if (audioStatusEl) audioStatusEl.textContent = 'Live conversation active. Ask your question!';
        if (audioTranscriptsEl) audioTranscriptsEl.textContent = 'Listening...';
        toggleAudioBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Conversation';
      } catch (err) {
        stopAudioSession(err.message);
      }
    }

    function stopAudioSession(errorMsg) {
      if (audioPeer) {
        try { audioPeer.close(); } catch (_) {}
        audioPeer = null;
      }
      if (audioStream) {
        audioStream.getTracks().forEach(track => track.stop());
        audioStream = null;
      }
      if (assistantAudioEl) assistantAudioEl.srcObject = null;
      audioTranscriptBuffer = '';
      audioActive = false;
      if (audioStatusEl) {
        audioStatusEl.style.display = 'block';
        audioStatusEl.textContent = errorMsg ? `Audio session ended: ${errorMsg}` : 'Audio session stopped.';
      }
      if (audioTranscriptsEl) {
        audioTranscriptsEl.style.display = 'block';
        audioTranscriptsEl.textContent = 'Speak to start...';
      }
      toggleAudioBtn.innerHTML = '<i class="fas fa-microphone"></i> Start Conversation';
    }

    if (toggleAudioBtn) {
      toggleAudioBtn.addEventListener('click', () => {
        if (audioActive) {
          stopAudioSession();
        } else {
          initAudioSession();
        }
      });
    }

    if (customerAnalyzeBtn) {
      customerAnalyzeBtn.addEventListener('click', () => loadCustomerInsight());
    }
    if (customerNameInput) {
      customerNameInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          loadCustomerInsight();
        }
      });
    }
    if (customerVoiceBtn) {
      customerVoiceBtn.addEventListener('click', captureCustomerName);
    }
  </script>
</body>
</html>
